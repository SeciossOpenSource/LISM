<config>
  <data name="CSV">
    <container>
      <oc>organizationalUnit</oc>
      <rdn>ou=CSV</rdn>
    </container>
    <handler name="Rewrite">
      <libload>LISM/Utils/lism_util.pl</libload>
      <rewrite context="searchResult" dn=",ou=Organizations," match=",ou=Organizations," substitution=",ou=%{getValue('%0', 'parent', '')},ou=Organizations," />
      <rewrite context="searchResult" dn=",ou=Organizations," match=",(ou=[^,]+),ou=Organizations," substitution=",%{path2dn('%1', 'ou', '1')},ou=Organizations," />
      <rewrite context="searchResult" dn=",ou=People," match="(userPassword: .+)" substitution="%1\nseciossPwdChangedTime: %{time2date()}" />
      <rewrite context="searchResult" dn=",ou=People," match="sn(|;lang-ja;phonetic): (.*)" substitution="cn%1: %2 %{getValue('%0', 'givenName%1', '')}\nsn%1: %2" />
      <rewritemap name="getValue" type="function" />
      <rewritemap name="path2dn" type="function" />
      <rewritemap name="time2date" type="function" />
    </handler>
    <storage name="CSV">
      <object name="Organization">
        <attr name="description">
          <column>1</column>
          <multival>off</multival>
        </attr>
        <attr name="ou">
          <column>0</column>
          <multival>off</multival>
        </attr>
        <attr name="parent">
          <column>2</column>
          <multival>off</multival>
        </attr>
        <container>
          <oc>organizationalUnit</oc>
          <rdn>ou=Organizations</rdn>
        </container>
        <file>/opt/secioss/var/lib/tenantcsv/organization.csv</file>
        <id>
          <column>0</column>
        </id>
        <oc>organizationalUnit</oc>
        <rdn>ou</rdn>
        <valdelim>;</valdelim>
      </object>
      <object name="User">
        <attr name="uid">
          <column>0</column>
          <multival>off</multival>
        </attr>
        <attr name="employeenumber">
          <column>1</column>
          <multival>off</multival>
        </attr>
        <attr name="sn">
          <column>2</column>
          <multival>off</multival>
        </attr>
        <attr name="givenname">
          <column>3</column>
          <multival>off</multival>
        </attr>
        <attr name="sn;lang-ja;phonetic">
          <column>4</column>
          <multival>off</multival>
        </attr>
        <attr name="givenname;lang-ja;phonetic">
          <column>5</column>
          <multival>off</multival>
        </attr>
        <attr name="mail">
          <column>6</column>
          <multival>off</multival>
        </attr>
        <attr name="seciossaccountstatus">
          <column>7</column>
          <multival>off</multival>
        </attr>
        <attr name="userpassword">
          <column>8</column>
          <multival>off</multival>
        </attr>
        <attr name="ou">
          <column>9</column>
          <multival>off</multival>
        </attr>
        <container>
          <oc>organizationalUnit</oc>
          <rdn>ou=People</rdn>
        </container>
        <file>/opt/secioss/var/lib/tenantcsv/user.csv</file>
        <id>
          <column>0</column>
        </id>
        <oc>Person</oc>
        <oc>organizationalPerson</oc>
        <oc>inetOrgPerson</oc>
        <oc>seciossIamAccount</oc>
        <oc>seciossPerson</oc>
        <rdn>uid</rdn>
        <valdelim>;</valdelim>
      </object>
    </storage>
  </data>
  <data name="DB">
    <container>
      <oc>organizationalUnit</oc>
      <rdn>ou=DB</rdn>
    </container>
    <storage name="SQL" hash="SSHA">
      <libload>LISM/Utils/lism_util.pl</libload>
      <dsn>DBI:mysql:dbname=sample;host=localhost</dsn>
      <admin>admin</admin>
      <passwd>adminpass</passwd>
      <object name="User">
        <container>
          <oc>organizationalUnit</oc>
          <rdn>ou=People</rdn>
        </container>
        <noop>delete</noop>
        <table>user</table>
        <id>
          <column>user_id</column>
        </id>
        <oc>Person</oc>
        <oc>inetOrgPerson</oc>
        <oc>seciossIamAccount</oc>
        <rdn>uid</rdn>
        <attr name="uid">
          <column>user_id</column>
        </attr>
        <attr name="employeenumber">
          <column>emp_code</column>
        </attr>
        <attr name="sn">
          <column>last_name</column>
        </attr>
        <attr name="givenname">
          <column>first_name</column>
        </attr>
        <attr name="mail">
          <column>mail</column>
        </attr>
        <attr name="userpassword">
          <selexpr>password</selexpr>
          <fromtbls>password</fromtbls>
          <joinwhere>user_id = '%o' AND delete_flag = 0</joinwhere>
          <addproc>update password set delete_flag = 1 where delete_flag = 0 and user_id = '%o'</addproc>
          <addproc>insert into password(user_id, change_date, password, delete_flag) values(%o, current_timestamp, '%a', 0)</addproc>
        </attr>
      </object>
    </storage>
  </data>
  <data name="LDAP">
    <container>
      <oc>organizationalUnit</oc>
      <rdn>ou=LDAP</rdn>
    </container>
    <handler name="Check" useprevious="on">
      <check dn="^uid=[^,]+,ou=People," filter="(!(seciossAccountStatus=deleted))" op="add,modify">
        <attr name="displayname">
          <maxlen>100</maxlen>
        </attr>
        <attr name="employeenumber">
          <maxlen>100</maxlen>
          <regexp>^[a-zA-Z0-9\._-]+$</regexp>
        </attr>
        <attr name="givenname">
          <maxlen>60</maxlen>
          <required>on</required>
        </attr>
        <attr name="givenname;lang-ja;phonetic">
          <maxlen>60</maxlen>
        </attr>
        <attr name="mail">
          <lismunique>ou=LDAP,dc=example,dc=com?mail,seciossMailAlias?sub?(&amp;(objectClass=seciossIamAccount)(&amp;(!(seciossAccountStatus=deleted))(&amp;(!(uid=%i))(|(!(mail;x-old=%a))(&amp;(mail;x-old=%a)(seciossMailAlias=%a))))))</lismunique>
          <maxlen>64</maxlen>
          <regexp>^[a-zA-Z0-9_]+[a-zA-Z0-9\._\-']*@[a-zA-Z0-9]+[a-zA-Z0-9._-]+$</regexp>
          <required>on</required>
        </attr>
        <attr name="objectclass">
          <regexp>^(top|.*Person|seciossIamAccount)$</regexp>
        </attr>
        <attr name="ou">
          <lismexist>ou=LDAP,dc=example,dc=com?path?base?(objectClass=organizationalUnit)</lismexist>
        </attr>
        <attr name="seciossaccountstatus">
          <regexp>^(active|inactive|deleted)$</regexp>
          <required>on</required>
        </attr>
        <attr name="sn">
          <maxlen>60</maxlen>
          <required>on</required>
        </attr>
        <attr name="sn;lang-ja;phonetic">
          <maxlen>60</maxlen>
        </attr>
        <attr name="uid">
          <maxlen>129</maxlen>
          <regexp>^[a-zA-Z0-9\._-]+$</regexp>
          <required>on</required>
        </attr>
        <command>/usr/local/sbin/checkfile.sh /tmp/check</command>
      </check>
      <check dn=",ou=Organizations," op="add,modify">
        <attr name="description">
          <maxlen>255</maxlen>
        </attr>
        <attr name="objectclass">
          <regexp>^(top|organizationalUnit)$</regexp>
        </attr>
        <attr name="ou">
          <maxlen>100</maxlen>
          <regexp>^[^\t/]+$</regexp>
          <required>on</required>
        </attr>
      </check>
    </handler>
    <handler name="Rewrite" useprevious="on">
      <libload>LISM/Utils/lism_util.pl</libload>
      <rewrite context="request" dn="^uid=[^,]+,ou=People," match="^modifyTimestamp:" substitution="seciossPersonModifyTime:" />
      <rewrite context="request" dn="^uid=[^,]+,ou=People," match="^userPassword: (.*)$" substitution="userPassword: %1\nseciossEncryptedPassword: %{encrypt3des('%1', 'QbtkO8voc4sU3xPADWsQAzbj')}" />
      <rewritemap name="encrypt3des" type="function" />
    </handler>
    <storage master="true" name="LDAP" hash="SSHA">
      <uri>ldap://localhost/dc=example,dc=com</uri>
      <binddn>cn=Manager,dc=example,dc=com</binddn>
      <bindpw>secret</bindpw>
      <deleteflag name="seciossAccountStatus" dn=",ou=(People|Groups)," filter="(objectClass=seciossIamAccount)" ovrfilter="(seciossAccountStatus=deleted)" value="deleted" />
      <deleteflag name="seciossPersonStatus" dn=",ou=Contacts," filter="(objectClass=seciossPerson)" ovrfilter="(seciossPersonStatus=deleted)" value="deleted" />
    </storage>
  </data>
  <sync>
    <data name="CSV">
      <object name="Organization">
        <masterattr>
          <name>objectClass</name>
        </masterattr>
        <masterattr>
          <name>ou</name>
        </masterattr>
        <masterattr>
          <name>description</name>
          <filter>(!(description=nosync))</filter>
        </masterattr>
        <masterdn>ou=Organizations</masterdn>
        <masterfilter>(objectClass=organizationalUnit)</masterfilter>
      </object>
      <object name="User">
        <masterattr>
          <name>objectClass</name>
        </masterattr>
        <masterattr>
          <name>uid</name>
        </masterattr>
        <masterattr>
          <name>employeenumber</name>
          <filter>(!(employeenumber=nosync))</filter>
        </masterattr>
        <masterattr>
          <name>cn</name>
        </masterattr>
        <masterattr>
          <name>sn</name>
        </masterattr>
        <masterattr>
          <name>givenname</name>
        </masterattr>
        <masterattr>
          <name>cn;lang-ja;phonetic</name>
          <filter>(!(sn;lang-ja;phonetic=nosync))</filter>
        </masterattr>
        <masterattr>
          <name>sn;lang-ja;phonetic</name>
          <filter>(!(sn;lang-ja;phonetic=nosync))</filter>
        </masterattr>
        <masterattr>
          <name>givenname;lang-ja;phonetic</name>
          <filter>(!(givenname;lang-ja;phonetic=nosync))</filter>
        </masterattr>
        <masterattr>
          <name>mail</name>
        </masterattr>
        <masterattr>
          <name>userpassword</name>
          <option>notnull</option>
        </masterattr>
        <masterattr>
          <name>seciossaccountstatus</name>
        </masterattr>
        <masterattr>
          <name>ou</name>
          <filter>(!(ou=nosync))</filter>
        </masterattr>
        <masterdn>ou=People</masterdn>
        <masterfilter>(&amp;(objectClass=inetOrgPerson)(!(seciossAccountStatus=deleted)))</masterfilter>
      </object>
    </data>
    <data name="DB">
      <object name="Organization">
        <syncattr>
          <name>ou</name>
        </syncattr>
        <syncattr>
          <name>description</name>
          <filter>(!(description=nosync))</filter>
        </syncattr>
        <syncdn>ou=Organizations</syncdn>
        <syncfilter>(objectClass=organizationalUnit)</syncfilter>
      </object>
      <object name="User">
        <syncattr>
          <name>uid</name>
        </syncattr>
        <syncattr>
          <name>employeenumber</name>
        </syncattr>
        <syncattr>
          <name>sn</name>
        </syncattr>
        <syncattr>
          <name>givenname</name>
        </syncattr>
        <syncattr>
          <name>mail</name>
        </syncattr>
        <syncattr>
          <name>userpassword</name>
          <type>realtime</type>
        </syncattr>
        <syncdn>ou=People</syncdn>
        <syncfilter>(objectClass=inetOrgPerson)</syncfilter>
      </object>
    </data>
    <delorder>first</delorder>
    <master>
      <containerdn>ou=Master</containerdn>
      <data>LDAP</data>
    </master>
    <transaction>off</transaction>
  </sync>
</config>
